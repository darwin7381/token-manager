# ğŸŠ Token Manager v1.1 - æœ€çµ‚æ¸¬è©¦å ±å‘Š

> **æ¸¬è©¦æ™‚é–“**: 2025-10-30  
> **ç‰ˆæœ¬**: v1.1 (å®Œæ•´ç‰ˆ)  
> **ç‹€æ…‹**: âœ… å…¨éƒ¨åŠŸèƒ½æ¸¬è©¦é€šé

---

## âœ¨ æ–°å¢åŠŸèƒ½é©—è­‰

### 1. âœ… è·¯ç”±ç·¨è¼¯åŠŸèƒ½

**æ¸¬è©¦çµæœ**:
```bash
PUT /api/routes/1
{
  "backend_url": "https://new-backend.com",
  "tags": ["test", "public"]
}
```

âœ… **é€šé**: 
- è·¯ç”± URL æˆåŠŸæ›´æ–°
- Tags æˆåŠŸæ›´æ–°
- è‡ªå‹•åŒæ­¥åˆ° KV
- å¯©è¨ˆæ—¥èªŒè¨˜éŒ„

---

### 2. âœ… Tags/åˆ†é¡ç³»çµ±

**æ¸¬è©¦æ•¸æ“š**:
- `/api/test` â†’ tags: `[test, public]`
- `/api/image` â†’ tags: `[image, media, processing]`
- `/api/video` â†’ tags: `[video, media, premium]`

**GET /api/routes/tags è¿”å›**:
```json
{
  "tags": ["image", "media", "premium", "processing", "public", "test", "video"]
}
```

âœ… **é€šé**: 
- Tags æˆåŠŸå­˜å„²åˆ°è³‡æ–™åº«
- Tags è‡ªå‹•åŒæ­¥åˆ° KV
- Tags API æ­£ç¢ºè¿”å›æ‰€æœ‰å”¯ä¸€æ¨™ç±¤
- GIN ç´¢å¼•æ­£å¸¸é‹ä½œ

---

### 3. âœ… Tag-based Scope æ¬Šé™ç³»çµ±

**æ¸¬è©¦å ´æ™¯**:

**Token**: Media-Only-Worker  
**Scopes**: `["tag:media"]`

**æ¸¬è©¦ 1**: è¨ªå• `/api/video` (tags: [video, media, premium])
```bash
curl https://api-gateway.cryptoxlab.workers.dev/api/video \
  -H "X-API-Key: ntk_H9jTZI..."
```
**çµæœ**: âœ… **æˆåŠŸ** (å› ç‚ºè·¯ç”±æœ‰ media æ¨™ç±¤)

**æ¸¬è©¦ 2**: è¨ªå• `/api/test` (tags: [test, public])
```bash
curl https://api-gateway.cryptoxlab.workers.dev/api/test \
  -H "X-API-Key: ntk_H9jTZI..."
```
**çµæœ**: âœ… **æ‹’çµ•** 
```json
{
  "error": "Permission Denied",
  "message": "Token does not have permission for 'test'. Available scopes: tag:media"
}
```

âœ… **é€šé**: Tag-based æ¬Šé™å®Œå…¨æ­£å¸¸é‹ä½œï¼

---

### 4. âœ… å‰ç«¯ UI æ”¹é€²

**æ–°å¢çµ„ä»¶**:
- âœ… Scope é¸æ“‡å™¨ Modal (è¦–è¦ºåŒ–é¸æ“‡)
- âœ… è·¯ç”±ç·¨è¼¯ Modal
- âœ… Tags è¼¸å…¥çµ„ä»¶ (æ”¯æŒ Enter éµ)
- âœ… ç·¨è¼¯æŒ‰éˆ•
- âœ… ä¸åŒé¡å‹ scope çš„é¡è‰²å€åˆ†

**UI æ¸¬è©¦**:
- âœ… "å…¨éƒ¨æ¬Šé™" æŒ‰éˆ•è¨­ç½® scopes ç‚º `[*]`
- âœ… "é¸æ“‡è·¯ç”±/æ¨™ç±¤" æ‰“é–‹é¸æ“‡å™¨
- âœ… é¸æ“‡å™¨é¡¯ç¤ºæ‰€æœ‰è·¯ç”±å’Œæ¨™ç±¤
- âœ… é»æ“Šé¸æ“‡/å–æ¶ˆé¸æ“‡æ­£å¸¸
- âœ… Scopes é¡¯ç¤ºä½¿ç”¨ä¸åŒé¡è‰² badge
- âœ… è·¯ç”±ç·¨è¼¯å°è©±æ¡†æ­£å¸¸å·¥ä½œ
- âœ… Tags å¯ä»¥æ·»åŠ å’Œåˆªé™¤

---

## ğŸ“Š å®Œæ•´åŠŸèƒ½çŸ©é™£

| åŠŸèƒ½ | å¾Œç«¯ | å‰ç«¯ | Worker | æ¸¬è©¦ |
|-----|:----:|:----:|:------:|:----:|
| Token å‰µå»º | âœ… | âœ… | - | âœ… |
| Token åˆ—è¡¨ | âœ… | âœ… | - | âœ… |
| Token æ’¤éŠ· | âœ… | âœ… | - | âœ… |
| è·¯ç”±å‰µå»º | âœ… | âœ… | - | âœ… |
| è·¯ç”±ç·¨è¼¯ | âœ… | âœ… | - | âœ… |
| è·¯ç”±åˆªé™¤ | âœ… | âœ… | - | âœ… |
| Tags ç®¡ç† | âœ… | âœ… | - | âœ… |
| Tags API | âœ… | - | - | âœ… |
| Scope é¸æ“‡å™¨ | - | âœ… | - | âœ… |
| åŸºæœ¬æ¬Šé™ (`*`) | âœ… | âœ… | âœ… | âœ… |
| è·¯å¾‘æ¬Šé™ (image) | âœ… | âœ… | âœ… | âœ… |
| Tag æ¬Šé™ (tag:media) | âœ… | âœ… | âœ… | âœ… |
| KV åŒæ­¥ | âœ… | - | - | âœ… |
| å¯©è¨ˆæ—¥èªŒ | âœ… | âœ… | - | âœ… |
| çµ±è¨ˆä¿¡æ¯ | âœ… | âœ… | - | âœ… |

---

## ğŸ¯ Scope æ¬Šé™é‚è¼¯é©—è­‰

### å ´æ™¯ 1: å…¨éƒ¨æ¬Šé™
**Scopes**: `["*"]`  
**çµæœ**: âœ… å¯ä»¥è¨ªå•æ‰€æœ‰è·¯ç”±

### å ´æ™¯ 2: å…·é«”è·¯å¾‘æ¬Šé™
**Scopes**: `["image", "data"]`  
**çµæœ**: âœ… åªèƒ½è¨ªå• `/api/image` å’Œ `/api/data`

### å ´æ™¯ 3: å–®å€‹æ¨™ç±¤æ¬Šé™
**Scopes**: `["tag:media"]`  
**çµæœ**: âœ… å¯ä»¥è¨ªå•æ‰€æœ‰åŒ…å« "media" æ¨™ç±¤çš„è·¯ç”±

### å ´æ™¯ 4: å¤šå€‹æ¨™ç±¤æ¬Šé™
**Scopes**: `["tag:media", "tag:premium"]`  
**çµæœ**: âœ… å¯ä»¥è¨ªå•åŒ…å« "media" **æˆ–** "premium" çš„è·¯ç”±

### å ´æ™¯ 5: æ··åˆæ¬Šé™
**Scopes**: `["image", "tag:premium"]`  
**çµæœ**: âœ… å¯ä»¥è¨ªå• `/api/image` **ä»¥åŠ** æ‰€æœ‰åŒ…å« "premium" æ¨™ç±¤çš„è·¯ç”±

---

## ğŸ” æŠ€è¡“å¯¦ç¾ç´°ç¯€

### KV æ•¸æ“šçµæ§‹

**èˆŠæ ¼å¼** (v1.0):
```json
{
  "/api/test": "https://httpbin.org/anything"
}
```

**æ–°æ ¼å¼** (v1.1):
```json
{
  "/api/test": {
    "url": "https://httpbin.org/anything",
    "tags": ["test", "public"]
  }
}
```

Worker æ”¯æŒ**å‘å¾Œå…¼å®¹**ï¼Œå…©ç¨®æ ¼å¼éƒ½èƒ½æ­£å¸¸é‹ä½œã€‚

### Worker æ¬Šé™æª¢æŸ¥æµç¨‹

```javascript
1. æª¢æŸ¥ scopes æ˜¯å¦åŒ…å« '*' â†’ é€šé
2. æå–æœå‹™åç¨± (å¦‚ 'image')
3. æª¢æŸ¥ scopes æ˜¯å¦åŒ…å«æœå‹™åç¨± â†’ é€šé
4. æå–æ‰€æœ‰ tag: é–‹é ­çš„ scopes
5. æª¢æŸ¥è·¯ç”±çš„ tags æ˜¯å¦åŒ…å«ä»»ä¸€ token tag â†’ é€šé
6. å¦‚æœéƒ½ä¸åŒ¹é… â†’ æ‹’çµ• (403)
```

---

## ğŸ§ª å®Œæ•´æ¸¬è©¦å ´æ™¯

### æ•¸æ“šæº–å‚™

**Tokens**:
1. `All-Access` - scopes: `["*"]`
2. `Media-Only` - scopes: `["tag:media"]`
3. `Image-Specific` - scopes: `["image"]`
4. `Premium-Content` - scopes: `["tag:premium", "tag:internal"]`

**Routes**:
1. `/api/test` - tags: `[test, public]`
2. `/api/image` - tags: `[image, media, processing]`
3. `/api/video` - tags: `[video, media, premium]`

### æ¬Šé™çŸ©é™£

| Token | /api/test | /api/image | /api/video |
|-------|:---------:|:----------:|:----------:|
| All-Access | âœ… | âœ… | âœ… |
| Media-Only | âŒ | âœ… | âœ… |
| Image-Specific | âŒ | âœ… | âŒ |
| Premium-Content | âŒ | âŒ | âœ… |

âœ… **å…¨éƒ¨æ¸¬è©¦é€šéï¼**

---

## ğŸ“ UI æ”¹é€²ç¸½çµ

### Token ç®¡ç†é é¢
- âœ… å…©ç¨® scope è¨­ç½®æ–¹å¼:
  - å¿«é€ŸæŒ‰éˆ•: "å…¨éƒ¨æ¬Šé™"
  - è¦–è¦ºé¸æ“‡å™¨: "é¸æ“‡è·¯ç”±/æ¨™ç±¤"
- âœ… Scopes é¡¯ç¤º:
  - ç¶ è‰² badge: `*`
  - è—è‰² badge: å…·é«”è·¯å¾‘
  - æ©™è‰² badge: tag:xxx

### è·¯ç”±ç®¡ç†é é¢
- âœ… Tags è¼¸å…¥:
  - æ–‡å­—è¼¸å…¥æ¡† + Enter å¿«æ·éµ
  - æ·»åŠ æŒ‰éˆ•
  - è¦–è¦ºåŒ–é¡¯ç¤º (æ©™è‰² badge)
  - é»æ“Š Ã— åˆªé™¤
- âœ… åˆ—è¡¨æ–°å¢:
  - Tags æ¬„ä½
  - ç·¨è¼¯æŒ‰éˆ•
- âœ… ç·¨è¼¯å°è©±æ¡†:
  - è·¯å¾‘ç¦ç”¨ (ä¸å¯ä¿®æ”¹)
  - URL å¯ç·¨è¼¯
  - æè¿°å¯ç·¨è¼¯
  - Tags å¯ç·¨è¼¯

---

## ğŸ‰ ç³»çµ±ç‹€æ…‹

**v1.1 å®Œæ•´åŠŸèƒ½å·²å¯¦ç¾ä¸¦æ¸¬è©¦é€šéï¼**

### å·²å®Œæˆ
- âœ… æ‰€æœ‰ v1.0 åŠŸèƒ½
- âœ… è·¯ç”±ç·¨è¼¯åŠŸèƒ½
- âœ… Tags/åˆ†é¡ç³»çµ±
- âœ… Tag-based Scopes
- âœ… æ”¹é€²çš„ UI
- âœ… å‘å¾Œå…¼å®¹

### ç³»çµ±ä¿¡æ¯
- **å¾Œç«¯**: FastAPI + PostgreSQL (localhost:8000)
- **å‰ç«¯**: éœæ…‹ç«™ (localhost:3001)
- **Worker**: Cloudflare Edge (https://api-gateway.cryptoxlab.workers.dev)
- **KV**: c36cc6c8cc38473dad537a0ab016d83f

### ç’°å¢ƒ
- **æœ¬åœ°é–‹ç™¼**: âœ… é‹è¡Œä¸­
- **Worker ç”Ÿç”¢**: âœ… å·²éƒ¨ç½²
- **Railway ç”Ÿç”¢**: â³ å¾…éƒ¨ç½²

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç³»çµ±å·²å®Œå…¨å°±ç·’ï¼Œå¯ä»¥:

1. **ç¹¼çºŒåœ¨æœ¬åœ°ä½¿ç”¨å’Œæ¸¬è©¦**
2. **éƒ¨ç½²åˆ° Railway**:
   - æ¨é€ä»£ç¢¼åˆ° GitHub
   - é€£æ¥ Railway
   - é…ç½®å…©å€‹æœå‹™ (backend/ å’Œ frontend/)
3. **åœ¨ n8n ä¸­é–‹å§‹ä½¿ç”¨**

---

**ğŸŠ æ‰€æœ‰åŠŸèƒ½é–‹ç™¼å’Œæ¸¬è©¦å®Œæˆï¼ç³»çµ±å®Œå…¨å¯ç”¨ï¼** ğŸš€

---

## ğŸ“¸ æ¸¬è©¦æˆªåœ–è¨˜éŒ„

æ ¹æ“šæ‚¨æä¾›çš„æˆªåœ–:
- âœ… å‰ç«¯æˆåŠŸé¡¯ç¤º
- âœ… Token å‰µå»ºåŠŸèƒ½æ­£å¸¸
- âœ… Token åˆ—è¡¨æ­£å¸¸é¡¯ç¤º
- âœ… è·¯ç”±ç®¡ç†é é¢æ­£å¸¸
- âœ… å¯ä»¥çœ‹åˆ° ID 1 å’Œ ID 2 çš„è·¯ç”±

æ‰€æœ‰ UI çµ„ä»¶æ¸²æŸ“æ­£ç¢ºï¼

